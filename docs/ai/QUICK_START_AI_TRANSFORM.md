# AI Transformation Validation - Quick Start Guide

Get started with AI Transformation Validation in 5 minutes.

## Installation

Ensure CrossBridge is installed with required dependencies:

```bash
pip install -r requirements.txt
```

## Basic Usage

### 1. Generate Your First Transformation

```python
from core.ai.transformation_service import AITransformationService
from core.ai.transformation_validation import ConfidenceSignals

# Initialize service
service = AITransformationService()

# Generate a transformation
transformation = service.generate(
    operation="generate",
    artifact_type="test",
    artifact_path="tests/test_example.py",
    before_content="",
    after_content="""
def test_example():
    '''Example test generated by AI'''
    assert 1 + 1 == 2
""",
    model="gpt-4",
    prompt="Generate a simple example test",
    signals=ConfidenceSignals(
        model_confidence=0.9,
        diff_size=5,
        syntax_valid=True
    )
)

print(f"Created transformation: {transformation.id}")
print(f"Confidence: {transformation.confidence}")
print(f"Requires review: {transformation.requires_review}")
```

### 2. Review Transformations via CLI

```bash
# List all transformations needing review
crossbridge ai-transform list --needs-review

# View details with diff
crossbridge ai-transform show ai-abc123 --show-diff

# Approve and apply
crossbridge ai-transform approve ai-abc123 \
    --reviewer your@email.com \
    --comments "Looks good" \
    --apply
```

### 3. Handle Low Confidence Transformations

```python
if transformation.requires_review:
    print(f"⚠ Review required (confidence: {transformation.confidence})")
    print(f"Run: crossbridge ai-transform show {transformation.id}")
else:
    print(f"✓ High confidence, applying automatically")
    service.apply(transformation.id)
```

## Common Workflows

### Workflow 1: Generate → Review → Apply

```python
# 1. Generate
transformation = service.generate(
    operation="generate",
    artifact_type="test",
    artifact_path="tests/test_login.py",
    before_content="",
    after_content=ai_generated_code,
    model="gpt-4",
    prompt="Generate login test"
)

# 2. Review (via CLI)
# $ crossbridge ai-transform show ai-abc123 --show-diff

# 3. Approve
approved = service.approve(
    transformation.id,
    reviewer="reviewer@example.com",
    comments="Test coverage looks good"
)

# 4. Apply
applied = service.apply(transformation.id)
print(f"✓ Applied to {applied.artifact_path}")
```

### Workflow 2: Apply → Verify → Rollback (if needed)

```python
# 1. Apply transformation
service.apply(transformation.id)

# 2. Run tests to verify
test_result = run_tests()

# 3. Rollback if tests fail
if not test_result.passed:
    print("Tests failed, rolling back...")
    service.rollback(transformation.id)
    print("✓ Rolled back successfully")
```

### Workflow 3: Batch Review

```bash
# List all pending reviews
crossbridge ai-transform list --status pending_review

# Review each one
for id in $(crossbridge ai-transform list --needs-review --format json | jq -r '.[].id'); do
    crossbridge ai-transform show $id --show-diff
    read -p "Approve? (y/n): " answer
    if [ "$answer" = "y" ]; then
        crossbridge ai-transform approve $id --reviewer you@example.com
    else
        read -p "Reason for rejection: " reason
        crossbridge ai-transform reject $id --reviewer you@example.com --reason "$reason"
    fi
done
```

## Configuration

### Adjust Confidence Threshold

```python
# More conservative (more reviews required)
service = AITransformationService(confidence_threshold=0.9)

# Default
service = AITransformationService(confidence_threshold=0.8)

# More aggressive (fewer reviews)
service = AITransformationService(confidence_threshold=0.6)
```

### Custom Storage Location

```python
from pathlib import Path

service = AITransformationService(
    storage_dir=Path("/custom/path/transformations")
)
```

### Custom Apply/Rollback Functions

```python
def git_apply(transformation):
    """Apply via git commit"""
    Path(transformation.artifact_path).write_text(transformation.after_snapshot)
    os.system(f"git add {transformation.artifact_path}")
    os.system(f"git commit -m 'AI: {transformation.operation}'")
    return True

def git_rollback(transformation):
    """Rollback via git"""
    os.system(f"git checkout HEAD~1 -- {transformation.artifact_path}")
    return True

# Use custom functions
service.apply(transformation.id, apply_fn=git_apply)
service.rollback(transformation.id, rollback_fn=git_rollback)
```

## CLI Quick Reference

| Command | Description | Example |
|---------|-------------|---------|
| `list` | List transformations | `crossbridge ai-transform list --needs-review` |
| `show` | View details | `crossbridge ai-transform show ai-abc123 --show-diff` |
| `approve` | Approve transformation | `crossbridge ai-transform approve ai-abc123 --reviewer john@example.com` |
| `reject` | Reject transformation | `crossbridge ai-transform reject ai-abc123 --reason "Syntax errors"` |
| `apply` | Apply approved | `crossbridge ai-transform apply ai-abc123` |
| `rollback` | Revert applied | `crossbridge ai-transform rollback ai-abc123` |
| `audit` | View audit trail | `crossbridge ai-transform audit ai-abc123` |
| `stats` | Show statistics | `crossbridge ai-transform stats` |

## Tips & Best Practices

### ✓ DO

- **Always provide confidence signals** - More signals = better confidence scoring
- **Review low confidence transformations** - Never bypass review for <0.8 confidence
- **Test before applying** - Use staging/test environments first
- **Use audit trails** - Track what works and what doesn't
- **Set appropriate thresholds** - Adjust based on your risk tolerance

### ✗ DON'T

- **Don't auto-merge low confidence** - Always require human review
- **Don't skip syntax validation** - Check code parses before applying
- **Don't ignore rejection reasons** - Learn from rejections to improve
- **Don't forget to test rollback** - Verify rollback works in your environment
- **Don't bypass the system** - Always use the validation workflow

## Example: Complete Integration

Here's a complete example integrating AI generation with validation:

```python
from core.ai.transformation_service import AITransformationService
from core.ai.transformation_validation import ConfidenceSignals
import subprocess

def generate_and_validate_test(test_name, ai_prompt):
    """Generate test with AI and validate"""
    
    # Initialize service
    service = AITransformationService()
    
    # Generate with your AI model
    ai_code = your_ai_model.generate(ai_prompt)
    
    # Check syntax
    syntax_valid = check_python_syntax(ai_code)
    
    # Create transformation
    transformation = service.generate(
        operation="generate",
        artifact_type="test",
        artifact_path=f"tests/{test_name}.py",
        before_content="",
        after_content=ai_code,
        model="gpt-4",
        prompt=ai_prompt,
        signals=ConfidenceSignals(
            model_confidence=your_ai_model.confidence,
            syntax_valid=syntax_valid,
            diff_size=len(ai_code.split('\n')),
            rule_violations=count_lint_errors(ai_code)
        )
    )
    
    # Handle based on confidence
    if transformation.confidence >= 0.8:
        print(f"✓ High confidence ({transformation.confidence:.2f})")
        
        # Apply
        service.apply(transformation.id)
        
        # Run tests
        result = subprocess.run(['pytest', transformation.artifact_path])
        
        if result.returncode != 0:
            print("✗ Tests failed, rolling back...")
            service.rollback(transformation.id)
            return None
        
        print(f"✓ Tests passed, applied to {transformation.artifact_path}")
        return transformation
    
    else:
        print(f"⚠ Low confidence ({transformation.confidence:.2f}), review required")
        print(f"Review with: crossbridge ai-transform show {transformation.id}")
        return transformation

# Helper functions
def check_python_syntax(code):
    """Check if Python code is syntactically valid"""
    try:
        compile(code, '<string>', 'exec')
        return True
    except SyntaxError:
        return False

def count_lint_errors(code):
    """Count linting errors (example with flake8)"""
    # Implement your linting check
    return 0
```

## Next Steps

1. **Read the full documentation**: [AI_TRANSFORMATION_VALIDATION.md](AI_TRANSFORMATION_VALIDATION.md)
2. **Explore examples**: Check `examples/ai_transformation_examples.py`
3. **Run the tests**: `pytest tests/unit/core/test_ai_transformation.py`
4. **Integrate with your workflow**: Start with high-confidence auto-apply, then expand
5. **Monitor statistics**: Use `crossbridge ai-transform stats` to track performance

## Getting Help

- **Documentation**: `docs/ai/AI_TRANSFORMATION_VALIDATION.md`
- **CLI Help**: `crossbridge ai-transform --help`
- **Examples**: `examples/ai_transformation_examples.py`
- **Tests**: `tests/unit/core/test_ai_transformation.py`

## Troubleshooting

**Issue**: Can't find `crossbridge ai-transform` command

**Solution**: Make sure CrossBridge CLI is installed and in PATH:
```bash
pip install -e .
```

**Issue**: Transformations not persisting

**Solution**: Check storage directory exists and is writable:
```bash
mkdir -p .crossbridge/transformations
chmod 755 .crossbridge/transformations
```

**Issue**: All transformations require review

**Solution**: Provide confidence signals when generating:
```python
signals = ConfidenceSignals(
    model_confidence=0.9,  # Don't forget this!
    syntax_valid=True,
    diff_size=20
)
```

---

**Ready to start?** Try generating your first transformation with the examples above!