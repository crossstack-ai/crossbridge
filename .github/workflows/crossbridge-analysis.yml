name: CrossBridge Test Intelligence

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install CrossBridge
        run: |
          pip install --upgrade pip
          pip install crossbridge
          # Or for development:
          # pip install -e .
      
      - name: Validate Environment
        run: |
          python scripts/validate_environment.py || true
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
      - name: Analyze Test Suite
        run: |
          crossbridge analyze \
            --path tests/ \
            --output analysis-report.json \
            --format json \
            --verbose
        env:
          LOG_LEVEL: INFO
          ENABLE_AI_FEATURES: ${{ secrets.ENABLE_AI_FEATURES || 'false' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Generate Coverage Report
        run: |
          crossbridge coverage \
            --path tests/ \
            --output coverage-report.html \
            --format html
        continue-on-error: true
      
      - name: Detect Flaky Tests
        run: |
          crossbridge flaky-detect \
            --path tests/ \
            --threshold 0.8 \
            --output flaky-tests.json
        continue-on-error: true
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      
      - name: Upload Analysis Results
        uses: actions/upload-artifact@v3
        with:
          name: crossbridge-analysis
          path: |
            analysis-report.json
            coverage-report.html
            flaky-tests.json
          retention-days: 30
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ðŸ¤– CrossBridge Analysis Results\\n\\n';
            
            // Read analysis report
            try {
              const analysis = JSON.parse(fs.readFileSync('analysis-report.json', 'utf8'));
              
              comment += '### Test Suite Summary\\n';
              comment += `- **Total Tests**: ${analysis.total_tests}\\n`;
              comment += `- **Frameworks Detected**: ${analysis.frameworks.join(', ')}\\n`;
              comment += `- **Test Files**: ${analysis.test_files_count}\\n\\n`;
              
              if (analysis.issues && analysis.issues.length > 0) {
                comment += '### âš ï¸ Issues Found\\n';
                analysis.issues.slice(0, 5).forEach(issue => {
                  comment += `- **${issue.severity}**: ${issue.description}\\n`;
                });
                if (analysis.issues.length > 5) {
                  comment += `\\n_... and ${analysis.issues.length - 5} more issues_\\n`;
                }
              } else {
                comment += '### âœ… No Issues Found\\n';
              }
            } catch (e) {
              comment += 'âš ï¸ Could not parse analysis report\\n';
            }
            
            // Read flaky tests report
            try {
              const flaky = JSON.parse(fs.readFileSync('flaky-tests.json', 'utf8'));
              
              if (flaky.flaky_tests && flaky.flaky_tests.length > 0) {
                comment += '\\n### ðŸ”„ Flaky Tests Detected\\n';
                flaky.flaky_tests.slice(0, 3).forEach(test => {
                  comment += `- \`${test.test_name}\` (flakiness: ${(test.flakiness_score * 100).toFixed(1)}%)\\n`;
                });
                if (flaky.flaky_tests.length > 3) {
                  comment += `\\n_... and ${flaky.flaky_tests.length - 3} more flaky tests_\\n`;
                }
              }
            } catch (e) {
              // Flaky tests report might not exist
            }
            
            comment += '\\n---\\n';
            comment += '_Generated by [CrossBridge](https://github.com/crossstack-ai/crossbridge)_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check for Critical Issues
        run: |
          python -c "
          import json
          import sys
          
          with open('analysis-report.json') as f:
              analysis = json.load(f)
          
          critical_issues = [
              issue for issue in analysis.get('issues', [])
              if issue.get('severity') == 'critical'
          ]
          
          if critical_issues:
              print(f'âŒ Found {len(critical_issues)} critical issues')
              for issue in critical_issues:
                  print(f\"  - {issue['description']}\")
              sys.exit(1)
          else:
              print('âœ… No critical issues found')
          "

  transform:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install CrossBridge
        run: |
          pip install --upgrade pip
          pip install crossbridge
      
      - name: Detect Changed Test Files
        id: changed-files
        uses: tj-actions/changed-files@v39
        with:
          files: |
            **/*test*.py
            **/*Test*.java
            **/*.robot
      
      - name: Validate Changed Tests
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed test files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Validating $file..."
            crossbridge validate --file "$file" || true
          done
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  performance:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: crossbridge
          POSTGRES_USER: crossbridge_user
          POSTGRES_PASSWORD: crossbridge_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install CrossBridge
        run: |
          pip install --upgrade pip
          pip install crossbridge
          pip install pytest pytest-benchmark
      
      - name: Run Performance Benchmarks
        run: |
          pytest tests/performance/ \
            --benchmark-only \
            --benchmark-json=benchmark-results.json
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: crossbridge
          DB_USER: crossbridge_user
          DB_PASSWORD: crossbridge_pass
      
      - name: Store Benchmark Results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'pytest'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true

  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Security Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Check for Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
