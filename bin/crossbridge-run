#!/usr/bin/env bash
#
# CrossBridge Universal Test Wrapper
# Automatically injects CrossBridge monitoring into any supported test framework
#
# Usage:
#   crossbridge-run robot tests/
#   crossbridge-run pytest tests/
#   crossbridge-run jest tests/
#   crossbridge-run mvn test
#

set -e

# Configuration from environment (use standard CROSSBRIDGE_SIDECAR_* variables)
CROSSBRIDGE_SIDECAR_HOST="${CROSSBRIDGE_SIDECAR_HOST:-localhost}"
CROSSBRIDGE_SIDECAR_PORT="${CROSSBRIDGE_SIDECAR_PORT:-8765}"
CROSSBRIDGE_ENABLED="${CROSSBRIDGE_ENABLED:-true}"
CROSSBRIDGE_ADAPTER_DIR="${CROSSBRIDGE_ADAPTER_DIR:-$HOME/.crossbridge/adapters}"

# Backward compatibility: support old CROSSBRIDGE_API_* variable names
if [ -n "$CROSSBRIDGE_API_HOST" ]; then
    CROSSBRIDGE_SIDECAR_HOST="$CROSSBRIDGE_API_HOST"
fi
if [ -n "$CROSSBRIDGE_API_PORT" ]; then
    CROSSBRIDGE_SIDECAR_PORT="$CROSSBRIDGE_API_PORT"
fi

# Color output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[CrossBridge]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[CrossBridge]${NC} $1"
}

log_error() {
    echo -e "${RED}[CrossBridge]${NC} $1"
}

# Check if sidecar is reachable
check_sidecar() {
    if curl -s --connect-timeout 2 "http://${CROSSBRIDGE_SIDECAR_HOST}:${CROSSBRIDGE_SIDECAR_PORT}/health" > /dev/null 2>&1; then
        log_info "✅ Connected to CrossBridge sidecar at ${CROSSBRIDGE_SIDECAR_HOST}:${CROSSBRIDGE_SIDECAR_PORT}"
        return 0
    else
        log_warn "⚠️  Cannot reach CrossBridge sidecar at ${CROSSBRIDGE_SIDECAR_HOST}:${CROSSBRIDGE_SIDECAR_PORT}"
        log_warn "Tests will run without CrossBridge monitoring"
        export CROSSBRIDGE_ENABLED=false
        return 1
    fi
}

# Download adapter from sidecar
download_adapter() {
    local framework=$1
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/${framework}"
    
    # Skip if adapter already exists and is recent (< 24 hours)
    if [[ -d "$adapter_path" ]]; then
        local age_seconds=$(($(date +%s) - $(stat -c %Y "$adapter_path" 2>/dev/null || stat -f %m "$adapter_path" 2>/dev/null || echo 0)))
        if [[ $age_seconds -lt 86400 ]]; then
            log_info "Using cached ${framework} adapter"
            return 0
        fi
    fi
    
    log_info "Downloading ${framework} adapter from sidecar..."
    
    mkdir -p "$CROSSBRIDGE_ADAPTER_DIR"
    local tar_file="${CROSSBRIDGE_ADAPTER_DIR}/${framework}.tar.gz"
    
    if curl -s -f -o "$tar_file" "http://${CROSSBRIDGE_SIDECAR_HOST}:${CROSSBRIDGE_SIDECAR_PORT}/adapters/${framework}"; then
        tar -xzf "$tar_file" -C "$CROSSBRIDGE_ADAPTER_DIR"
        rm -f "$tar_file"
        log_info "✅ ${framework} adapter downloaded"
        return 0
    else
        log_error "Failed to download ${framework} adapter"
        return 1
    fi
}

# Detect framework from command
detect_framework() {
    local cmd=$1
    
    case "$cmd" in
        robot|pybot)
            echo "robot"
            ;;
        pytest|py.test)
            echo "pytest"
            ;;
        jest)
            echo "jest"
            ;;
        mocha|_mocha)
            echo "mocha"
            ;;
        mvn|maven)
            echo "junit"
            ;;
        npm|yarn)
            # Check if it's a test command
            if [[ "$2" == "test" ]] || [[ "$2" == "run" && "$3" == "test" ]]; then
                # Try to detect from package.json
                if [[ -f "package.json" ]]; then
                    if grep -q '"jest"' package.json; then
                        echo "jest"
                    elif grep -q '"mocha"' package.json; then
                        echo "mocha"
                    else
                        echo "unknown"
                    fi
                else
                    echo "unknown"
                fi
            else
                echo "unknown"
            fi
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

# Setup Robot Framework
setup_robot() {
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/robot"
    
    if [[ ! -d "$adapter_path" ]]; then
        download_adapter "robot" || return 1
    fi
    
    export PYTHONPATH="${adapter_path}:${PYTHONPATH}"
    export ROBOT_OPTIONS="--listener crossbridge_listener.CrossBridgeListener ${ROBOT_OPTIONS}"
    
    log_info "Robot Framework configured with CrossBridge listener"
}

# Setup Pytest
setup_pytest() {
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/pytest"
    
    if [[ ! -d "$adapter_path" ]]; then
        download_adapter "pytest" || return 1
    fi
    
    export PYTHONPATH="${adapter_path}:${PYTHONPATH}"
    export PYTEST_PLUGINS="crossbridge_plugin"
    
    log_info "Pytest configured with CrossBridge plugin"
}

# Setup Jest
setup_jest() {
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/jest"
    
    if [[ ! -d "$adapter_path" ]]; then
        download_adapter "jest" || return 1
    fi
    
    # Add reporter to jest command if not already present
    if [[ ! "$*" =~ "--reporters" ]]; then
        JEST_EXTRA_ARGS="--reporters=default --reporters=${adapter_path}/crossbridge_reporter.js"
    fi
    
    log_info "Jest configured with CrossBridge reporter"
}

# Setup Mocha
setup_mocha() {
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/mocha"
    
    if [[ ! -d "$adapter_path" ]]; then
        download_adapter "mocha" || return 1
    fi
    
    # Add reporter to mocha command if not already present
    if [[ ! "$*" =~ "--reporter" ]]; then
        MOCHA_EXTRA_ARGS="--reporter ${adapter_path}/crossbridge_reporter.js"
    fi
    
    log_info "Mocha configured with CrossBridge reporter"
}

# Setup JUnit/Maven
setup_junit() {
    local adapter_path="${CROSSBRIDGE_ADAPTER_DIR}/junit"
    
    if [[ ! -d "$adapter_path" ]]; then
        download_adapter "junit" || return 1
    fi
    
    log_warn "JUnit adapter downloaded to ${adapter_path}"
    log_warn "Please add CrossBridgeListener to your test configuration"
    log_warn "See: ${adapter_path}/README.md for instructions"
}

# Main execution
main() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: crossbridge-run <test-command> [args...]"
        echo ""
        echo "Examples:"
        echo "  crossbridge-run robot tests/"
        echo "  crossbridge-run pytest tests/"
        echo "  crossbridge-run jest tests/"
        echo "  crossbridge-run mocha tests/"
        echo "  crossbridge-run mvn test"
        echo ""
        echo "Environment Variables:"
        echo "  CROSSBRIDGE_SIDECAR_HOST   - Sidecar API host (default: localhost)"
        echo "  CROSSBRIDGE_SIDECAR_PORT   - Sidecar API port (default: 8765)"
        echo "  CROSSBRIDGE_ENABLED        - Enable/disable CrossBridge (default: true)"
        echo "  CROSSBRIDGE_ADAPTER_DIR    - Adapter cache directory (default: ~/.crossbridge/adapters)"
        exit 1
    fi
    
    # Export configuration
    export CROSSBRIDGE_ENABLED
    export CROSSBRIDGE_SIDECAR_HOST
    export CROSSBRIDGE_SIDECAR_PORT
    
    # Check sidecar connection
    check_sidecar
    
    if [[ "$CROSSBRIDGE_ENABLED" != "true" ]]; then
        log_warn "Running tests without CrossBridge monitoring"
        exec "$@"
        exit $?
    fi
    
    # Detect framework
    local framework=$(detect_framework "$1" "$2" "$3")
    
    if [[ "$framework" == "unknown" ]]; then
        log_warn "Unknown test framework: $1"
        log_warn "Running tests without CrossBridge monitoring"
        exec "$@"
        exit $?
    fi
    
    log_info "Detected framework: ${framework}"
    
    # Setup framework-specific integration
    case "$framework" in
        robot)
            setup_robot
            # Shift to remove 'robot' from args, then add back with options
            shift
            exec robot $ROBOT_OPTIONS "$@"
            ;;
        pytest)
            setup_pytest
            exec "$@"
            ;;
        jest)
            setup_jest
            exec "$@" $JEST_EXTRA_ARGS
            ;;
        mocha)
            setup_mocha
            exec "$@" $MOCHA_EXTRA_ARGS
            ;;
        junit)
            setup_junit
            exec "$@"
            ;;
        *)
            log_error "Framework setup not implemented: ${framework}"
            exec "$@"
            ;;
    esac
}

main "$@"
